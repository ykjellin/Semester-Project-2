import { BASE_URL } from "../constants.mjs";
import { getItem } from "../storage.mjs";

export async function fetchAuctions(filters = {}) {
  try {
    const apiKey = getItem("apiKey");
    const authToken = getItem("authToken");

    if (!apiKey || !authToken) {
      console.error("API key or auth token is missing");
      return [];
    }

    const queryParams = new URLSearchParams(filters).toString();

    const response = await fetch(
      `${BASE_URL}/auction/listings?${queryParams}`,
      {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "X-Noroff-API-Key": apiKey,
          Authorization: `Bearer ${authToken}`,
        },
      }
    );

    if (!response.ok) {
      throw new Error(`Error fetching auctions: ${response.status}`);
    }

    const auctionData = await response.json();
    console.log(auctionData);
    return auctionData.data;
  } catch (error) {
    console.error("Fetch Auctions Error: ", error);
    return [];
  }
}

export function renderAuctions(auctions) {
  const auctionListContainer = document.getElementById("auction-list");
  const template = document.getElementById("auction-card-template");

  auctionListContainer.innerHTML = "";

  auctions.forEach((auction) => {
    const auctionCard = document.importNode(template.content, true);

    auctionCard.querySelector("#auction-title").textContent = auction.title;
    auctionCard.querySelector("#auction-description").textContent =
      auction.description;

    const auctionImg = auctionCard.querySelector("#auction-img");
    if (auction.media && auction.media.length > 0) {
      auctionImg.src = auction.media[0].url;
      auctionImg.alt = auction.media[0].alt || "Auction Image";
    } else {
      auctionImg.src = "default-image.jpg";
    }

    const viewAuctionBtn = auctionCard.querySelector("#view-auction");
    viewAuctionBtn.href = `/auction/${auction.id}`;

    auctionListContainer.appendChild(auctionCard);
  });
}

export async function loadAuctions() {
  const filters = {
    sort: document.getElementById("sort").value,
    sortOrder: document.getElementById("sortOrder").value,
    limit: document.getElementById("limit").value,
    page: 1,
    _seller: document.getElementById("_seller").checked ? true : undefined,
    _bids: document.getElementById("_bids").checked ? true : undefined,
    _active: document.getElementById("_active").checked ? true : undefined,
    _tag: document.getElementById("tag").value,
  };

  const auctions = await fetchAuctions(filters);
  renderAuctions(auctions);
}
